#!/usr/bin/env groovy
import com.ge.nola.cfg.BanzaiCfg
import com.ge.nola.cfg.BanzaiVulnerabilityCfg
import com.ge.nola.BanzaiStage
import com.ge.nola.BanzaiEvent

def call(BanzaiCfg cfg, List<BanzaiVulnerabilityCfg> vulnerabilityCfgs) {
    def stages = [:]
    def pipeline = this
    vulnerabilityCfgs.each {
        switch (it.type) {
            case 'checkmarx':
                stages[it.type] = {
                    String stageName = 'Checkmarx'
                    BanzaiStage banzaiStage = new BanzaiStage(
                        pipeline: pipeline,
                        cfg: cfg,
                        stageName: stageName
                    )
                    banzaiStage.execute {
                        try {
                            checkmarx(cfg, it)
                            notify(cfg, [
                                scope: BanzaiEvent.Scope.VULNERABILITY,
                                status: BanzaiEvent.Status.SUCCESS,
                                stage: stageName,
                                message: 'Checkmarx Scan Success',
                                attachmentPattern: '**/ScanReport.pdf'
                            ])
                        } catch (Exception e) {
                            logger "${e.message}"
                            notify(cfg, [
                                scope: BanzaiEvent.Scope.VULNERABILITY,
                                status: BanzaiEvent.Status.FAILURE,
                                stage: stageName,
                                message: 'Checkmarx Scan Failure'
                            ])
                            currentBuild.result = 'UNSTABLE'
                            String abort = it.abortOnError ? 'true' : 'false'
                            throw new Exception(abort) // let the vulnerabilityStage know if it should abort
                        }
                    }
                }
                break
            case 'coverity':
                stages[it.type] = {
                    String stageName = 'Coverity'
                    BanzaiStage banzaiStage = new BanzaiStage(
                        pipeline: pipeline,
                        cfg: cfg,
                        stageName: stageName
                    )
                    banzaiStage.execute {
                        try {
                            coverity(cfg, it)
                            notify(cfg, [
                                scope: BanzaiEvent.Scope.VULNERABILITY,
                                status: BanzaiEvent.Status.SUCCESS,
                                stage: stageName,
                                message: 'Coverity Scan Success',
                                attachmentPattern: '**/idir/output/summary.txt'
                            ])
                        } catch (Exception e) {
                            logger "${e.message}"
                            notify(cfg, [
                                scope: BanzaiEvent.Scope.VULNERABILITY,
                                status: BanzaiEvent.Status.FAILURE,
                                stage: stageName,
                                message: 'Coverity Scan Failure'
                            ])
                            currentBuild.result = 'UNSTABLE'
                            String abort = it.abortOnError ? 'true' : 'false'
                            throw new Exception(abort) // let the vulnerabilityStage know if it should abort
                        }
                    }
                }
            default:
                logger("Unable to parse vulnerabilityScans cfg item: ${it}")
                break
        }
    }

    parallel(stages)
}